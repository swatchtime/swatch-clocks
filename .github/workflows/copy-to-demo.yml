name: Sync built artifacts to demo examples

on:
  push:
    branches: [ main ]
    paths:
      - 'src/clocks.js'
      - 'src/clocks.css'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  sync:
    name: Build and sync dist artifacts to demo repo (examples)
    runs-on: ubuntu-latest

    steps:
      - name: Check out current repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install deps and build
        run: |
          set -euo pipefail
          npm ci
          npm run build

      - name: Check out demo repository
        uses: actions/checkout@v4
        with:
          repository: swatchtime/swatch-clocks-demo
          path: demo
          # Requires a personal access token (repo scope) saved as DEMO_REPO_PAT
          token: ${{ secrets.DEMO_REPO_PAT }}
          fetch-depth: 0

      - name: Sync built dist files into demo examples and legacy vendor
        id: sync
        run: |
          set -euo pipefail

          # Ensure target vendor dirs exist (examples)
          mkdir -p demo/examples/preact-auto/public/vendor
          mkdir -p demo/examples/preact-manual/public/vendor

          # Copy recommended distribution artifacts:
          # - ESM bundle (used by Preact/Vite examples)
          # - UMD bundle (legacy demo via <script> tag)
          # - CSS
          cp -f dist/clocks.esm.js demo/examples/preact-auto/public/vendor/clocks.esm.js
          cp -f dist/clocks.esm.js demo/examples/preact-manual/public/vendor/clocks.esm.js
          cp -f dist/clocks.css demo/examples/preact-auto/public/vendor/clocks.css
          cp -f dist/clocks.css demo/examples/preact-manual/public/vendor/clocks.css

          # (legacy demo/vendor is deprecated and no longer copied)

          cd demo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # only add example vendor folders (legacy vendor directory removed)
          git add examples/preact-auto/public/vendor || true
          git add examples/preact-manual/public/vendor || true

          git commit -m "chore(demo): sync dist artifacts (clocks) from swatch-clocks @${{ github.sha }}" || echo "No changes to commit"
          git push origin main

      - name: Done
        run: |
          echo "Sync complete. Demo examples updated with built artifacts."
